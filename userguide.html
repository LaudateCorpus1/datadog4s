<h1 id="user-guide">User guide</h1>

<ul>
  <li><a href="#creating-metric-factory">Creating metric factory</a></li>
  <li><a href="#creating-metrics">Creating metrics</a></li>
  <li><a href="#timers">Timers</a></li>
  <li><a href="#tagging">Tagging</a>
    <ul>
      <li><a href="#tagger">Tagger</a></li>
    </ul>
  </li>
  <li><a href="#extensions">Extensions</a>
    <ul>
      <li><a href="#http4s">Http4s</a></li>
      <li><a href="#jvm-monitoring">Jvm monitoring</a></li>
    </ul>
  </li>
</ul>

<h2 id="creating-metric-factory">Creating metric factory</h2>

<p>To start creating your metrics, first you need to create a <code class="highlighter-rouge">MetricFactory[F[_]]</code>. Currently, the only implementation is
in <code class="highlighter-rouge">statsd</code> package. MetricFactory is purely functional, so it requires you to provide type constructor which
implements <code class="highlighter-rouge">cats.effect.Sync</code>. For the simplicity, we will use <code class="highlighter-rouge">cats.effect.IO</code> in these examples.</p>

<p>To create an instance, we need to provide it with configuration which contains a few basic fields, like address of the
StatsD server, prefix etc. For more information see scaladoc of the config class.</p>

<p>The instance is wrapped in <code class="highlighter-rouge">Resource</code> because of the underlying <code class="highlighter-rouge">StatsD</code> client.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">java.net.InetSocketAddress</span>
<span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">*</span>
<span class="k">import</span> <span class="nn">com.avast.datadog4s.api.</span><span class="o">*</span>
<span class="k">import</span> <span class="nn">com.avast.datadog4s.api.metric.</span><span class="o">*</span>
<span class="k">import</span> <span class="nn">com.avast.datadog4s.</span><span class="o">*</span>

<span class="k">val</span> <span class="nv">statsDServer</span> <span class="k">=</span> <span class="nv">InetSocketAddress</span><span class="o">.</span><span class="py">createUnresolved</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8125</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">config</span> <span class="k">=</span> <span class="nc">StatsDMetricFactoryConfig</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="s">"my-app-name"</span><span class="o">),</span> <span class="n">statsDServer</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">factoryResource</span><span class="k">:</span> <span class="kt">Resource</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">MetricFactory</span><span class="o">[</span><span class="kt">IO</span><span class="o">]]</span> <span class="k">=</span> <span class="nv">StatsDMetricFactory</span><span class="o">.</span><span class="py">make</span><span class="o">(</span><span class="n">config</span><span class="o">)</span>
</code></pre></div></div>

<h2 id="creating-metrics">Creating metrics</h2>

<p>Once you have a metrics factory, creating metrics is straight-forward. Note that all metric operations return
side-effecting actions.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">factoryResource</span><span class="o">.</span><span class="py">use</span> <span class="o">{</span> <span class="n">factory</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="nv">count</span><span class="k">:</span> <span class="kt">Count</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">factory</span><span class="o">.</span><span class="py">count</span><span class="o">(</span><span class="s">"hits"</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">histogram</span><span class="k">:</span> <span class="kt">Histogram</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Long</span><span class="o">]</span> <span class="k">=</span> <span class="nv">factory</span><span class="o">.</span><span class="py">histogram</span><span class="o">.</span><span class="py">long</span><span class="o">(</span><span class="s">"my-histogram"</span><span class="o">)</span>
    <span class="k">for</span> <span class="o">{</span>
        <span class="k">_</span> <span class="k">&lt;-</span>  <span class="nv">count</span><span class="o">.</span><span class="py">inc</span><span class="o">()</span> <span class="c1">// increase count by one</span>
        <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">histogram</span><span class="o">.</span><span class="py">record</span><span class="o">(</span><span class="mi">1337</span><span class="o">,</span> <span class="nv">Tag</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="s">"xyz"</span><span class="o">))</span> <span class="c1">// record a value to histogram with Tag</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="o">{</span>
        <span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="timers">Timers</h2>

<p>In addition to basic datadog metrics, we provide a <code class="highlighter-rouge">Timer[F]</code> abstraction which has proved to be very useful is
practice. Timers provide you with <code class="highlighter-rouge">.time[A](fa: F[A]): F[A]</code> method, which will measure how long it took to run
provided <code class="highlighter-rouge">fa</code>. In addition, it tags the metric with <code class="highlighter-rouge">success:true</code> or <code class="highlighter-rouge">success:false</code>
and <code class="highlighter-rouge">exception:&lt;&lt;throwable class name&gt;&gt;</code> in case the <code class="highlighter-rouge">fa</code> failed.</p>

<p>In addition to <code class="highlighter-rouge">.time[A]</code> method it also allows for recording of raw values that represent elapsed time or even raw time
data. You can see example of such calls below.</p>

<p>Optionally, when creating a <code class="highlighter-rouge">Timer</code>, you can also set the time units which will be used for reporting. By default, all
timers create with <code class="highlighter-rouge">microsecond</code> granularity. You can provide your own time unit if you need more or less precision.</p>

<h3 id="histogram-vs-distribution">Histogram vs Distribution</h3>

<p>There are two versions of timers, one backed by <code class="highlighter-rouge">Histogram</code> and one backed by <code class="highlighter-rouge">Distribution</code>. You can read scaladoc for
more details and links to datadog documentation.</p>

<p>Long story short, <code class="highlighter-rouge">histogram</code> backed timers are aggregated per datadog agent, while the <code class="highlighter-rouge">distributions</code> are computed on
datadog server. The implications are that <code class="highlighter-rouge">distribution</code> based timers, and it’s buckets (50th, 75th, 95th percentile
etc) are more correct and in general it’s the implementation that we’d suggest to use.</p>

<h3 id="example">Example</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">java.util.concurrent.TimeUnit</span>

<span class="nv">factoryResource</span><span class="o">.</span><span class="py">use</span> <span class="o">{</span> <span class="n">factory</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="nv">timer</span> <span class="k">=</span> <span class="nv">factory</span><span class="o">.</span><span class="py">timer</span><span class="o">.</span><span class="py">distribution</span><span class="o">(</span><span class="s">"request-latency"</span><span class="o">)</span>
    
    <span class="nv">timer</span><span class="o">.</span><span class="py">time</span><span class="o">(</span><span class="nv">IO</span><span class="o">.</span><span class="py">delay</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="s">"success"</span><span class="o">)))</span> <span class="c1">// tagged with success:true</span>
    <span class="nv">timer</span><span class="o">.</span><span class="py">time</span><span class="o">(</span><span class="nv">IO</span><span class="o">.</span><span class="py">raiseError</span><span class="o">(</span><span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">(</span><span class="s">"error"</span><span class="o">)))</span> <span class="c1">// tagged with success:false and exception:NullPointerException</span>
    
    <span class="k">val</span> <span class="nv">nanoTimer</span> <span class="k">=</span> <span class="nv">factory</span><span class="o">.</span><span class="py">timer</span><span class="o">.</span><span class="py">distribution</span><span class="o">(</span><span class="s">"nano-timer"</span><span class="o">,</span> <span class="n">timeUnit</span> <span class="k">=</span> <span class="nv">TimeUnit</span><span class="o">.</span><span class="py">NANOSECONDS</span><span class="o">)</span>
    <span class="nv">nanoTimer</span><span class="o">.</span><span class="py">time</span><span class="o">(</span><span class="nv">IO</span><span class="o">.</span><span class="py">delay</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="s">"success"</span><span class="o">)))</span> <span class="c1">// metric will be recorded with 'nanoseconds' precision</span>
    
    <span class="c1">// timer.record works for all types that implement `ElapsedTime` typeclass, out of the box we provide implementation</span>
    <span class="c1">// for java.time.Duration and scala.concurrent.duration.FiniteDuration</span>
    
    <span class="k">import</span> <span class="nn">java.time.Duration</span>
    <span class="nv">timer</span><span class="o">.</span><span class="py">record</span><span class="o">(</span><span class="nv">Duration</span><span class="o">.</span><span class="py">ofNanos</span><span class="o">(</span><span class="mi">1000</span><span class="o">))</span>
    
    <span class="k">import</span> <span class="nn">scala.concurrent.duration.FiniteDuration</span>
    <span class="nv">timer</span><span class="o">.</span><span class="py">record</span><span class="o">(</span><span class="nc">FiniteDuration</span><span class="o">(</span><span class="mi">1000</span><span class="o">,</span> <span class="nv">TimeUnit</span><span class="o">.</span><span class="py">MILLISECONDS</span><span class="o">))</span>
    
    <span class="nv">timer</span><span class="o">.</span><span class="py">recordTime</span><span class="o">(</span><span class="mi">1000L</span><span class="o">,</span> <span class="nv">TimeUnit</span><span class="o">.</span><span class="py">MILLISECONDS</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="tagging">Tagging</h2>

<p>There are two ways to create a <code class="highlighter-rouge">Tag</code> instances. One way is using <code class="highlighter-rouge">of</code> method of <code class="highlighter-rouge">Tag</code> object, like so:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.avast.datadog4s.api.Tag</span>

<span class="nv">Tag</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="s">"endpoint"</span><span class="o">,</span> <span class="s">"admin/login"</span><span class="o">)</span>
<span class="c1">// res2: String = "endpoint:admin/login"</span>
</code></pre></div></div>

<p>This is simple and straight-forward, but in some cases it leaves your code with <code class="highlighter-rouge">Tag</code> keys scattered around and forces
you to repeat it - making it prone to misspells etc. The better way is to use <code class="highlighter-rouge">Tagger</code>.</p>

<h3 id="tagger">Tagger</h3>

<p><code class="highlighter-rouge">Tagger[T]</code> is basically a factory interface for creating tags based on provided value of type <code class="highlighter-rouge">T</code> - as long as
implicit <code class="highlighter-rouge">TagValue[T]</code> exists in scope. This instance is used for converting <code class="highlighter-rouge">T</code> into <code class="highlighter-rouge">String</code>. By using <code class="highlighter-rouge">Tagger</code>, you
get a single value that you can use in multiple places in your code to create <code class="highlighter-rouge">Tag</code>s without repeating yourself.</p>

<p>Example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.avast.datadog4s.api.tag.</span><span class="o">{</span><span class="nc">TagValue</span><span class="o">,</span> <span class="nc">Tagger</span><span class="o">}</span>

<span class="k">val</span> <span class="nv">pathTagger</span><span class="k">:</span> <span class="kt">Tagger</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nv">Tagger</span><span class="o">.</span><span class="py">make</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"path"</span><span class="o">)</span>
<span class="c1">// pathTagger: Tagger[String] = com.avast.datadog4s.api.tag.Tagger$$anon$1@44b38dd2</span>
<span class="nf">assert</span><span class="o">(</span><span class="nv">Tag</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="s">"path"</span><span class="o">,</span> <span class="s">"admin/login"</span><span class="o">)</span> <span class="o">==</span> <span class="nv">pathTagger</span><span class="o">.</span><span class="py">tag</span><span class="o">(</span><span class="s">"admin/login"</span><span class="o">))</span>

<span class="c1">// tagger also supports taging using custom types using TagValue typeclass</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">StatusCode</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>  

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">statusCodeTagValue</span><span class="k">:</span> <span class="kt">TagValue</span><span class="o">[</span><span class="kt">StatusCode</span><span class="o">]</span> <span class="k">=</span> <span class="nc">TagValue</span><span class="o">[</span><span class="kt">Int</span><span class="o">].</span><span class="py">contramap</span><span class="o">[</span><span class="kt">StatusCode</span><span class="o">](</span><span class="n">sc</span> <span class="k">=&gt;</span> <span class="nv">sc</span><span class="o">.</span><span class="py">value</span><span class="o">)</span>
<span class="c1">// statusCodeTagValue: TagValue[StatusCode] = com.avast.datadog4s.api.tag.TagValue$$Lambda$7691/1909980104@58318d23</span>

<span class="k">val</span> <span class="nv">statusCodeTagger</span><span class="k">:</span> <span class="kt">Tagger</span><span class="o">[</span><span class="kt">StatusCode</span><span class="o">]</span> <span class="k">=</span> <span class="nv">Tagger</span><span class="o">.</span><span class="py">make</span><span class="o">[</span><span class="kt">StatusCode</span><span class="o">](</span><span class="s">"statusCode"</span><span class="o">)</span>
<span class="c1">// statusCodeTagger: Tagger[StatusCode] = com.avast.datadog4s.api.tag.Tagger$$anon$1@4d2021ce</span>

<span class="nf">assert</span><span class="o">(</span><span class="nv">Tag</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="s">"statusCode"</span><span class="o">,</span> <span class="s">"200"</span><span class="o">)</span> <span class="o">==</span> <span class="nv">statusCodeTagger</span><span class="o">.</span><span class="py">tag</span><span class="o">(</span><span class="nc">StatusCode</span><span class="o">(</span><span class="mi">200</span><span class="o">)))</span>
</code></pre></div></div>

<h2 id="extensions">Extensions</h2>

<p>Extensions are packages that monitor some functionality for you - without you having to do much.</p>

<h3 id="http4s">Http4s</h3>

<p>Http4s package (<code class="highlighter-rouge">datadog4s-http4s</code>) provides implementation of <a href="metrics-ops">MetricsOps</a> that is used
by <a href="http4s">http4s</a> to report both client and server metrics.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.avast.datadog4s.extension.http4s.</span><span class="o">*</span>

<span class="nv">factoryResource</span><span class="o">.</span><span class="py">use</span> <span class="o">{</span> <span class="n">metricFactory</span> <span class="k">=&gt;</span>
    <span class="c1">// create metrics factory and use it as you please</span>
    <span class="nv">DatadogMetricsOps</span><span class="o">.</span><span class="py">builder</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">metricFactory</span><span class="o">).</span><span class="py">build</span><span class="o">().</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">metricOps</span> <span class="k">=&gt;</span>
      <span class="c1">// setup http4s Metrics middleware here</span>
      <span class="k">val</span> <span class="nv">_</span> <span class="k">=</span> <span class="n">metricOps</span>
      <span class="nv">IO</span><span class="o">.</span><span class="py">unit</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">// res5: IO[Unit] = Uncancelable(</span>
<span class="c1">//   cats.effect.IO$$$Lambda$7687/1556847161@235d3480,</span>
<span class="c1">//   cats.effect.tracing.TracingEvent$StackTrace</span>
<span class="c1">// )</span>
</code></pre></div></div>

<h3 id="jvm-monitoring">Jvm monitoring</h3>

<p>JVM monitoring package (<code class="highlighter-rouge">datadog4s-jvm</code>) collects a bunch of JVM metrics that we found useful over last 5 or so years
running JVM apps in Avast. Those metrics can be found in <a href="https://github.com/avast/datadog4s/blob/master/code/jvm/src/main/scala/com/avast/datadog4s/extension/jvm/JvmReporter.scala">JvmReporter</a> and are hopefully
self-explanatory. We tried to match reported metrics to <a href="https://docs.datadoghq.com/tracing/runtime_metrics/java/">datadog JVM runtime metrics</a></p>

<p>Usage can not be simpler (unless you want to configure things like collection-frequency etc.). Simply add following to
your initialization code. Resource is returned, because a fiber is started in the background and has to be terminated
eventually.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.avast.datadog4s.extension.jvm.</span><span class="o">*</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.global</span> <span class="c1">// please don't use global EC in production</span>

<span class="k">val</span> <span class="nv">jvmMonitoring</span><span class="k">:</span> <span class="kt">Resource</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nv">factoryResource</span><span class="o">.</span><span class="py">flatMap</span> <span class="o">{</span>
  <span class="n">factory</span> <span class="k">=&gt;</span> <span class="nv">JvmMonitoring</span><span class="o">.</span><span class="py">default</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">factory</span><span class="o">)</span>
<span class="o">}</span>

<span class="nv">jvmMonitoring</span><span class="o">.</span><span class="py">use</span> <span class="o">{</span> <span class="k">_</span> <span class="k">=&gt;</span> 
    <span class="c1">// your application is in here</span>
    <span class="nv">IO</span><span class="o">.</span><span class="py">unit</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="note-on-java-compatibility">Note on Java compatibility:</h4>

<p>Starting with Java 16, applications that use our jvm monitoring need to
add <code class="highlighter-rouge">--add-opens=java.management/sun.management=ALL-UNNAMED</code> as JVM parameter when starting the application. This is
because JVM monitoring uses internal java APIs to obtain certain metrics.</p>

